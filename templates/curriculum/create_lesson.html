{% extends "base.html" %}

{% block title %}Create Lesson{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Create Lesson for: {{ topic.title }}</h4>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        <!-- Title -->
                        <div class="form-group mb-3">
                            <label for="title">Lesson Title</label>
                            <input type="text" class="form-control" name="title" id="title" required>
                        </div>

                        <!-- Description -->
                        <div class="form-group mb-3">
                            <label for="description">Short Description</label>
                            <input type="text" class="form-control" name="description" id="description" placeholder="Brief summary of this lesson">
                        </div>

                        <!-- Rich Text Editor -->
                        <div class="form-group mb-3">
                            <label for="theory_text">Lesson Content (Images & Video supported)</label>
                            <!-- This textarea is replaced by TinyMCE -->
                            <textarea id="theory_text" name="theory_text"></textarea>
                            <small class="form-text text-muted">
                                Use the toolbar to format text. 
                                <b>Image</b>: Click the image icon to upload. 
                                <b>Video</b>: Click the "Video Upload" button to upload MP4/WebM.
                            </small>
                        </div>

                        <!-- Lab Lesson Toggle -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="is_lab_lesson" id="is_lab_lesson">
                            <label class="form-check-label" for="is_lab_lesson">
                                Mark as Lab Lesson (Practical)
                            </label>
                        </div>

                        <!-- Order -->
                        <div class="form-group mb-3">
                            <label for="order">Order in Topic</label>
                            <input type="number" class="form-control" name="order" id="order" value="0">
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success">Create Lesson</button>
                            <a href="{{ url_for('course_detail', course_id=topic.module.course_id) }}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TinyMCE Script -->
<script src="https://cdn.tiny.cloud/1/ymw2kkq3u0pzce2v8l18jlu283auow2fvlotpxd6jl4ujgoo/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script>
  tinymce.init({
    selector: '#theory_text',
    height: 500,
    plugins: [
      'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
      'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
      'insertdatetime', 'media', 'table', 'help', 'wordcount'
    ],
    toolbar: 'undo redo | blocks | ' +
      'bold italic backcolor | alignleft aligncenter ' +
      'alignright alignjustify | bullist numlist outdent indent | ' +
      'removeformat | videoUpload | image | help',
    
    // Image Upload Configuration
    images_upload_url: '/editor/upload',
    automatic_uploads: true,
    images_upload_handler: function (blobInfo, success, failure) {
        var xhr, formData;
        xhr = new XMLHttpRequest();
        xhr.withCredentials = false;
        xhr.open('POST', '/editor/upload');
        xhr.onload = function() {
            var json;
            if (xhr.status != 200) {
                failure('HTTP Error: ' + xhr.status);
                return;
            }
            json = JSON.parse(xhr.responseText);
            if (!json || typeof json.location != 'string') {
                failure('Invalid JSON: ' + xhr.responseText);
                return;
            }
            success(json.location);
        };
        formData = new FormData();
        formData.append('file', blobInfo.blob(), blobInfo.filename());
        xhr.send(formData);
    },

    // Register a custom button for Local Video Uploads
    setup: function (editor) {
        editor.ui.registry.addButton('videoUpload', {
            text: 'Video Upload',
            icon: 'embed',
            onAction: function () {
                // Create a hidden file input
                var input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'video/*');
                
                input.onchange = function() {
                    var file = this.files[0];
                    if (file) {
                        var formData = new FormData();
                        formData.append('file', file);
                        
                        // Upload using fetch
                        fetch('/editor/upload', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.location) {
                                // Insert the video HTML
                                var html = '<p><span class="mce-preview-object mce-object-video" contenteditable="false"><video controls style="width: 100%; height: auto;" src="' + data.location + '"></video><span class="mce-shim"></span></span></p>';
                                editor.insertContent(html);
                            } else {
                                alert('Upload failed');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error uploading video');
                        });
                    }
                };
                
                input.click();
            }
        });
    },
    
    content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:16px }'
  });
</script>
{% endblock %}