{% extends "base.html" %}

{% block title %}Viewing: {{ resource.title }}{% endblock %}

{% block head %}
<!-- Script moved from here to the bottom to fix loading errors -->
<style>
/* ================================
   1. GLOBAL UI HIDING & RESET
================================= */
.navbar, .footer { display: none !important; }

html, body {
    margin: 0; padding: 0; width: 100%; height: 100%;
    background-color: #1a1a1a; overflow: hidden;
    -webkit-touch-callout: none !important;
    -webkit-user-select: none !important;
    user-select: none !important;
}

/* ================================
   2. CONTENT CONTAINERS
================================= */
.full-screen-container {
    position: fixed; inset: 0;
    display: flex; align-items: center; justify-content: center;
    z-index: 2000; background: #1a1a1a;
}

#pdf-canvas-container {
    width: 100%; height: 100vh;
    overflow-y: auto; overflow-x: hidden;
    display: flex; flex-direction: column; align-items: center;
    padding-top: 80px; /* Space for floating header */
    scroll-behavior: smooth;
}

canvas {
    margin-bottom: 20px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    max-width: 95vw;
}

/* Image Shield Overlay */
.img-shield {
    position: relative; display: inline-block;
    max-width: 100%; max-height: 100%;
}
.img-shield::after {
    content: ""; position: absolute; inset: 0;
    z-index: 10; background: rgba(0,0,0,0);
}

/* ================================
   3. FLOATING HEADER
================================= */
.floating-header {
    position: fixed; top: 18px; left: 50%;
    transform: translateX(-50%); z-index: 2500;
    background: rgba(255, 255, 255, 0.95);
    padding: 8px 16px; border-radius: 30px;
    display: flex; align-items: center; gap: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    pointer-events: auto !important;
}

.floating-header span {
    font-weight: 600; color: #000;
    max-width: 50vw; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}

/* ================================
   4. WATERMARK (optional)
================================= */
.watermark {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) rotate(-30deg);
    font-size: 40px;
    color: rgba(255, 255, 255, 0.1);
    pointer-events: none;
    z-index: 5000;
}
</style>
{% endblock %}

{% block content %}
<div class="full-screen-container">

    <div class="floating-header">
        <a href="{{ url_for('library_index') }}" class="btn btn-sm btn-dark" style="border-radius: 20px;">
            <i class="bi bi-x-lg"></i> Close
        </a>
        <span>{{ resource.title }}</span>
    </div>

    {% if resource.file_extension == 'pdf' %}
        <div id="pdf-canvas-container">
            <div id="pdf-loader" class="text-white mt-5">
                <div class="spinner-border text-light" role="status"></div>
                <p>Loading Document...</p>
            </div>
        </div>

    {% elif resource.file_extension in ['png', 'jpg', 'jpeg', 'gif', 'svg'] %}
        <div class="img-shield">
            <img src="{{ url_for('serve_library_file', filename=resource.file_name) }}" 
                 style="max-width:90vw; max-height:90vh; object-fit:contain;" draggable="false">
        </div>

    {% elif resource.file_extension in ['mp4', 'webm'] %}
        <video controls controlslist="nodownload noremoteplayback" disablepictureinpicture
               oncontextmenu="return false;" style="max-width:90vw; max-height:90vh;">
            <source src="{{ url_for('serve_library_file', filename=resource.file_name) }}">
        </video>
    {% endif %}

</div>

<!-- MOVED SCRIPT HERE TO ENSURE IT LOADS BEFORE OUR LOGIC -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
(function() {
    {% if resource.file_extension == 'pdf' %}
    const url = "{{ url_for('serve_library_file', filename=resource.file_name) }}";
    const container = document.getElementById('pdf-canvas-container');
    const loader = document.getElementById('pdf-loader');

    // 1. Verify PDF.js is loaded (FIXED: Changed to window.pdfjsLib)
    const pdfjsLib = window.pdfjsLib;
    
    if (!pdfjsLib) {
        console.error("PDF.js library not loaded!");
        loader.innerHTML = `<div class="alert alert-danger">Error: PDF library failed to load.<br>Check if you are using an AdBlocker.</div>`;
        return;
    }

    // 2. Configure Worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // 3. Define Rendering Function
    const renderPage = async (pdf, pageNumber, canvas) => {
        try {
            const page = await pdf.getPage(pageNumber);
            
            // Calculate scale to fit width (max 1.5 scale)
            const unscaledViewport = page.getViewport({ scale: 1 });
            const scale = Math.min(1.5, window.innerWidth / unscaledViewport.width);
            const viewport = page.getViewport({ scale: scale });

            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            // Render page
            await page.render({ canvasContext: context, viewport: viewport }).promise;

            // Optional Watermark
            const watermark = document.createElement('div');
            watermark.className = 'watermark';
            watermark.innerText = "{{ current_user.name }}";
            canvas.parentNode.appendChild(watermark);
            
        } catch (err) {
            console.error("Error rendering page " + pageNumber, err);
        }
    };

    async function renderPDF() {
        try {
            // Load PDF Document
            const loadingTask = pdfjsLib.getDocument({
                url: url,
                withCredentials: true,
                cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                cMapPacked: true
            });

            const pdf = await loadingTask.promise;
            console.log("PDF loaded, pages:", pdf.numPages);

            // 4. Setup Intersection Observer for remaining pages
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const canvas = entry.target;
                        const pageNum = parseInt(canvas.dataset.pageNumber);
                        
                        // Render the page
                        renderPage(pdf, pageNum, canvas);
                        
                        // Stop observing this canvas once rendered
                        observer.unobserve(canvas);
                    }
                });
            }, {
                root: container,
                rootMargin: '500px', // Pre-load aggressively
                threshold: 0.1
            });

            // 5. Loop through all pages
            for (let num = 1; num <= pdf.numPages; num++) {
                const canvas = document.createElement('canvas');
                canvas.style.marginBottom = "20px";
                canvas.style.boxShadow = "0 0 20px rgba(0,0,0,0.5)";
                canvas.style.maxWidth = "95vw";
                canvas.dataset.pageNumber = num;
                container.appendChild(canvas);

                if (num === 1) {
                    // RENDER PAGE 1 IMMEDIATELY (Fixes the blank screen issue)
                    await renderPage(pdf, 1, canvas);
                    // Hide loader only after Page 1 is visible
                    loader.style.display = 'none';
                } else {
                    // Lazy load other pages
                    observer.observe(canvas);
                }
            }

        } catch (err) {
            console.error("PDF load error:", err);
            loader.innerHTML = `<div class="alert alert-danger">Error loading PDF. ${err.message}</div>`;
        }
    }

    renderPDF();
    {% endif %}

    // Security scripts
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && ['s','p','u','i','j','c'].includes(e.key.toLowerCase())) e.preventDefault();
        if (e.key === 'F12') e.preventDefault();
    });
})();
</script>
{% endblock %}